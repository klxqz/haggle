
<div style="display: table;">
    <h2 align="center">{$settings.text_title|escape}</h2>


    <form id="haggle_form" action="{$wa->getUrl('shop/frontend/addProduct')}">
        {if $product.sku_type}
            <!-- SELECTABLE FEATURES selling mode -->
            {$default_sku_features = $product.sku_features}
            {$product_available = $product.status}
            <div class="options">
                {foreach $features_selectable as $f}
                    {$f.name}:
                    <select data-feature-id="{$f.id}" class="sku-feature" name="features[{$f.id}]">
                        {foreach $f.values as $v_id => $v}
                            <option value="{$v_id}" {if $v_id == ifset($default_sku_features[$f.id])}selected{/if}>{$v}</option>
                        {/foreach}
                    </select>
                    <br>
                {/foreach}
            </div>
        {else}

            <!-- FLAT SKU LIST selling mode -->
            {$product_available = false}
            {if count($product.skus) > 1}

                {* SKU selector *}

                <ul class="skus">
                    {foreach $product.skus as $sku}
                        {$sku_available =  $product.status && $sku.available && ($wa->shop->settings('ignore_stock_count') || $sku.count === null || $sku.count > 0)}
                        <li itemprop="offers" itemscope itemtype="http://schema.org/Offer">
                            <label{if !$sku.available} class="disabled"{/if}>
                                <input name="sku_id" type="radio" value="{$sku.id}"{if !$sku.available} disabled="true"{/if}{if !$sku_available}data-disabled="1"{/if}{if $sku.id == $product.sku_id} checked="checked"{/if} data-compare-price="{shop_currency($sku.compare_price, $product.currency, null, 0)}" data-price="{shop_currency($sku.price, $product.currency, null, 0)}"{if $sku.image_id} data-image-id="{$sku.image_id}"{/if}> <span itemprop="name">{$sku.name|escape}</span>
                                {if $sku.sku}<span class="hint" itemprop="name">{$sku.sku|escape}</span>{/if}
                                <meta itemprop="price" content="{shop_currency($sku.price, $product.currency)}">
                                <span class="price tiny nowrap">{shop_currency_html($sku.price, $product.currency)}</span>
                                {if (!($sku.count === null) && $sku.count <= 0)}
                                    <link itemprop="availability" href="http://schema.org/OutOfStock" />
                                {else}
                                    <link itemprop="availability" href="http://schema.org/InStock" />
                                {/if}
                            </label>
                        </li>
                        {$product_available = $product_available or $sku_available}
                    {/foreach}
                </ul>
            {else}

                {* in case there is only one SKU, don't display the selector *}

                <div itemprop="offers" itemscope itemtype="http://schema.org/Offer">
                    {$sku = $product.skus[$product.sku_id]}
                    {if $sku.sku}<span class="hint" itemprop="name">{$sku.sku|escape}</span>{/if}
                    <meta itemprop="price" content="{shop_currency($sku.price, $product.currency)}">
                    {if !$sku.available}
                        <link itemprop="availability" href="http://schema.org/Discontinued" />
                        <p><em class="bold error">[`This product is not available for purchase`]</em></p>
                    {elseif !$wa->shop->settings('ignore_stock_count') && !($sku.count === null || $sku.count > 0)}
                        <link itemprop="availability" href="http://schema.org/OutOfStock" />
                        <div class="stocks"><strong class="stock-none"><i class="icon16 stock-transparent"></i>{if $wa->shop->settings('ignore_stock_count')}[`Pre-order only`]{else}[`Out of stock`]{/if}</strong></div>
                    {else}
                        <link itemprop="availability" href="http://schema.org/InStock" />
                    {/if}
                    <input name="sku_id" type="hidden" value="{$product.sku_id}">
                    {$product_available = $product.status && $sku.available && ($wa->shop->settings('ignore_stock_count') || $sku.count === null || $sku.count > 0)}
                </div>

            {/if}

        {/if}






        <!-- price -->
        <div class="add2cart">

            <input type="hidden" name="product_id" value="{$product.id}">
            <input type="hidden" name="quantity" value="1">


            <table  id="haggle_table">
                <tr>
                    <td>{$settings.text_link|escape}<span class="required">*</span>:</td>
                    <td><input id="haggle_url" class="haggle_required_field" type="text" name="url" /></td>
                </tr>
                <tr>
                    <td>{$settings.text_user_price|escape}<span class="required">*</span>:</td>
                    <td><input id="haggle_price" class="haggle_required_field" type="text" name="price" /></td>
                </tr>
                <tr>
                    <td>{$settings.text_message|escape}:</td>
                    <td><textarea name="message" cols="40" rows="10" ></textarea></td>
                </tr>
                <tr>
                    <td colspan="2" align="center" >
                        <input type="submit" {if !$product_available}disabled="disabled"{/if} value="Купить за свою цену">
                    </td>
                </tr>
            </table>


        </div>

    </form>
    <div class="response"></div>
</div>


<script type="text/javascript" src="{$wa_app_static_url}plugins/haggle/js/product.js"></script>
<script type="text/javascript">
    $(function () {
        new HaggleProduct('#haggle_form', {
        currency: {json_encode($currency_info)}
    {if $product.sku_type}
        , features: {json_encode($sku_features_selectable)}
    {/if}
    });
    });</script>

<script type='text/javascript'>
            jQuery(function ($) {
                function is_numeric(mixed_var) {
                    return (typeof mixed_var === 'number' || typeof mixed_var === 'string') && mixed_var !== '' && !isNaN(mixed_var);
                }
                $('#haggle_form').submit(function () {
                    var required = false;
                    $('.haggle_required_field').each(function () {
                        if (!$(this).val().length) {
                            required = true;
                            $(this).css('border', '2px solid red');
                        }
                    });
                    if (required) {
                        $('.response').html('Заполните обязательные поля');
                        $('.response').css('color', 'red');
                    } else if (!is_numeric($('#haggle_price').val())) {
                        $('.response').html('Цена должна быть числом');
                        $('.response').css('color', 'red');
                    } else if (parseFloat($('#haggle_price').val()) < 0) {
                        $('.response').html('Цена должна быть больше нуля');
                        $('.response').css('color', 'red');
                    } else {
                        $.ajax({
                            type: 'POST',
                            url: $(this).attr('action'),
                            data: $(this).serialize(),
                            dataType: 'json',
                            success: function (data, textStatus, jqXHR) {
                                if (data.status == 'ok') {
                                    $('.response').css('color', 'green');
                                    $('.response').text(data.data.message);
                                } else {
                                    $('.response').css('color', 'red');
                                    $('.response').text(data.errors);
                                }
                            }
                        });
                    }
                    $('.response').show();
                    setTimeout(function () {
                        $('.haggle_required_field').css('border', '');
                        $('.response').hide();
                    }, 5000);
                    return false;
                });
                $('.haggle_link').click(function (e) {
                    $('#modal-content').modal();
                });
            });
</script>